<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>ESHD - Property Information Map</title>
  
  <!-- External Stylesheets -->
  <link rel="stylesheet" href="./css/leaflet.css">
  <link rel="stylesheet" href="./css/leaflet.groupedlayercontrol.css">
  <link rel="stylesheet" href="./css/leaflet-search.css">
  <link rel="stylesheet" href="./css/map.css">

  <!-- JavaScript library -->
  <script src="./javascript/leaflet-src.js"></script>

  <!-- Plugins -->
  <script src="./javascript/leaflet.groupedlayercontrol.js"></script>
  <script src="./javascript/leaflet-search.js"></script>

  <!-- geoJson overlays -->
  <script src="./javascript/aoss_installations.js"></script>
  <script src="./javascript/ac_parcels.js"></script>
  <script src="./javascript/ac_addresses.js"></script>
  <script src="./javascript/ac_soils.js"></script>
  <script src="./javascript/ac_capa.js"></script>
  <script src="./javascript/ac_populated_places.js"></script>
  <script src="./javascript/es_watersheds.js"></script>
  <script src="./javascript/nc_parcels.js"></script>
  <script src="./javascript/nc_soils.js"></script>
  <script src="./javascript/nc_capa.js"></script>
  <script src="./javascript/nc_populated_places.js"></script>
</head>

<body>
  <!-- Web map and content -->
  <div id="map" style="width: 100%; height: 100%"></div>
  <script>
  
    // Variable to hold map element, give initial settings to map
    var map = L.map('map',
    {
      center: [37.551181, -75.813965],
      zoom: 10
    });


    // Variables for basemap layers
    var Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    });

    var OpenStreetMap = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // Add popup window for features
    function ac_parcels_popup (feature, layer) {
      layer.bindPopup("<h2>Accomack County</h2>" + 
                              "<table><tr><td><b>Tax Map Number:  " + "</b></td><td>" + feature.properties.ac_tax_map + "</td></tr>" +
                              "<tr><td><b>Soil Symbol(s):  " + "</b></td><td>" + feature.properties.ac_soil_sym + "</td></tr>" +
                              "<tr><td><b>Soil Key(s):  " + "</b></td><td>" + feature.properties.ac_soil_key + "</td></tr>" +
                              "<tr><td><b>Soil Name(s):  " + "</b></td><td>" + feature.properties.ac_soil_name + "</td></tr>" +
                              "<tr><td><b>Hydrologic Unit - 6th Level Code(s):  " + "</b></td><td>" + feature.properties.ac_ws_huc12 + "</td></tr>" +
                              "<tr><td><b>Watershed Name(s):  " + "</b></td><td>" + feature.properties.ac_ws_name + "</td></tr>" + 
                              "<tr><td><b>CAPA Designation(s):  " + "</b></td><td>" + feature.properties.ac_capa + "</td></tr></table>"
                              );
    };

    function nc_parcels_popup (feature, layer) {
      layer.bindPopup("<h2>Northampton County</h2>" + 
                              "<table><tr><td><b>Tax Map Number:  " + "</b></td><td>" + feature.properties.nc_tax_map + "</td></tr>" +
                              "<tr><td><b>Soil Symbol(s):  " + "</b></td><td>" + feature.properties.nc_soil_sym + "</td></tr>" +
                              "<tr><td><b>Soil Key(s):  " + "</b></td><td>" + feature.properties.nc_soil_key + "</td></tr>" +
                              "<tr><td><b>Soil Name(s):  " + "</b></td><td>" + feature.properties.nc_soil_name + "</td></tr>" +
                              "<tr><td><b>Hydrologic Unit - 6th Level Code(s):  " + "</b></td><td>" + feature.properties.nc_ws_huc12 + "</td></tr>" +
                              "<tr><td><b>Watershed Name(s):  " + "</b></td><td>" + feature.properties.nc_ws_name + "</td></tr>" + 
                              "<tr><td><b>CAPA Designation(s):  " + "</b></td><td>" + feature.properties.nc_capa + "</td></tr></table>"
                              );
    };

    function aoss_installations_popup (feature, layer) {
      layer.bindPopup("<h1>AOSS Installation</h1><p>" + " Tax Map Number:  " + feature.properties.Tax_Map_Nu + "</p>");
    };

    // Create variables for geoJson overlays
    var aoss_installations = L.geoJson(aoss_installations, {
          onEachFeature: aoss_installations_popup
        }),
	
        ac_parcels = L.geoJson(ac_parcels, {
		      onEachFeature: ac_parcels_popup,
          style:  ac_parcels_style
        }),

        ac_soils = L.geoJson(ac_soils, {
          style:  ac_soils_style
        }),

        ac_addresses = L.geoJson(ac_addresses, {
        }),

        ac_populated_places = L.geoJson(ac_populated_places, {
        }),

        ac_capa = L.geoJson(ac_capa, {
          style:  ac_capa_style
        }),

        es_watersheds = L.geoJson(es_watersheds, {
          style:  es_watersheds_style
        }),

        nc_addresses = L.geoJson(nc_addresses, {
        }),

        nc_capa = L.geoJson(nc_capa, {
          style:  nc_capa_style
        }),

        nc_parcels = L.geoJson(nc_parcels, {
          onEachFeature: nc_parcels_popup,
          style:  nc_parcels_style
        }).addTo(map),

        nc_populated_places = L.geoJson(nc_populated_places, {
        }),

        nc_soils = L.geoJson(nc_soils, {
          style:  nc_soils_style
        });

    // Add search functionality
    var searchControl = new L.Control.Search({
    layer: ac_parcels,
    propertyName: 'ac_tax_map',
    marker: false,
    moveToLocation: function(latlng, title, map) {
      //map.fitBounds( latlng.layer.getBounds() );
      var zoom = map.getBoundsZoom(latlng.layer.getBounds());
        map.setView(latlng, zoom); // access the zoom
      }
    });

    searchControl.on('search:locationfound', function(e) {
    
    //console.log('search:locationfound', );

    //map.removeLayer(this._markerSearch)

    e.layer.setStyle({fillColor: null, color: '#2f00ff'});
    if(e.layer._popup)
      e.layer.openPopup();

    }).on('search:collapsed', function(e) {

    ac_parcels.eachLayer(function(layer) { //restore feature color
      ac_parcels.resetStyle(layer);
    }); 
     });
  
    map.addControl( searchControl );  //inizialize search control
    
    // Add Grouped Overlay Control
    var baseLayers = {
      "OpenStreetMaps":  OpenStreetMap,
      "ESRI World Imagery":  Esri_WorldImagery
    };

    var groupedOverlays = {
      "Coordinates": {
        "AOSS Installations":  aoss_installations,
        //"Well Installations":  ,
        //"Septic Tanks":  ,
        //"Distribution Boxes":  ,
        //"Drainfields":  
      },
      "Accomack County":  {
        "Addresses":  ac_addresses,
        "Parcels":  ac_parcels,
        "Soils":  ac_soils,
        "CAPA":  ac_capa,
        "Populated Places":  ac_populated_places
      },
      "Northampton County":  {
        "Addresses":  nc_addresses,
        "Parcels":  nc_parcels,
        "Soils":  nc_soils,
        "CAPA":  nc_capa,
        "Populated Places":  nc_populated_places
      },
      "Eastern Shore Watersheds":  {
        "Watersheds":  es_watersheds
      }
    };

    var options = {
      //groupCheckboxes: true
    };  

    var layerControl = L.control.groupedLayers(baseLayers, groupedOverlays, options);
    map.addControl(layerControl);
	
  </script>
</body>
</html>
